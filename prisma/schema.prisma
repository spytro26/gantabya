generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER MODEL ====================
model User {
  id       String  @id @default(uuid())
  name     String
  email    String  @unique
  password String
  verified Boolean @default(false) // Email verification for users, admin approval for admins
  phone    String? // Added for notifications
  busServiceName String @default("Ankush Travels") // Display name for admin's bus service

  role                Role           @default(USER)
  adminVerified       Boolean        @default(false) // Only for ADMIN role - verified by super admin
  adminVerificationAt DateTime? // When admin was verified
  groups              BookingGroup[]
  ownedBuses          Bus[] // For admin's buses
  notifications       Notification[]
  createdAt           DateTime       @default(now())
}

model EmailVerification {
  id        Int      @id @default(autoincrement())
  email     String
  otp       String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model PasswordReset {
  id        Int      @id @default(autoincrement())
  email     String
  otp       String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
}

model SuperAdmin {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  createdAt DateTime @default(now())
}

enum Role {
  USER
  ADMIN
  SUPERADMIN
}

// ==================== BUS MODEL ====================
model Bus {
  id         String     @id @default(uuid())
  adminId    String
  admin      User       @relation(fields: [adminId], references: [id], onDelete: Cascade)
  busNumber  String     @unique
  name       String
  type       BusType
  layoutType LayoutType
  totalSeats Int        @default(0)

  // Grid dimensions for realistic bus layout (rotated 90° - narrow width, long length)
  gridRows    Int @default(15) // Bus length (front to back) - max 15 rows
  gridColumns Int @default(4) // Bus width (side to side) - max 4 columns (like 2+2 or single+aisle+single)

  seats     Seat[]
  stops     Stop[]
  trips     Trip[]
  amenities BusAmenities?
  holidays  Holiday[] // Days when this bus doesn't run
  images    BusImage[] // Bus images uploaded by admin
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([adminId])
  @@index([busNumber])
}

enum BusType {
  SEATER
  SLEEPER
  MIXED
}

enum LayoutType {
  TWO_TWO // 2+2 seating (4 seats per row)
  THREE_TWO // 3+2 seating (5 seats per row)
  FOUR_TWO // 4+2 seating (6 seats per row)
}

// ==================== STOP MODEL ====================
model Stop {
  id            String  @id @default(uuid())
  busId         String
  bus           Bus     @relation(fields: [busId], references: [id], onDelete: Cascade)
  name          String
  city          String // City name for better filtering
  state         String? // Optional state
  stopIndex     Int // Order of stop (0 = origin, 1 = next, etc.)
  arrivalTime   String? // Time in format "10:30 AM" - Null for first stop (forward trip)
  departureTime String? // Time in format "10:30 AM" - Null for last stop (forward trip)

  // Return trip timings (for reverse direction)
  returnArrivalTime   String? // Arrival time when traveling in reverse (e.g., D→A)
  returnDepartureTime String? // Departure time when traveling in reverse

  distanceFromOrigin Float @default(0) // Distance in KM from origin
  priceFromOrigin    Float @default(0) // Cumulative price from origin (DEPRECATED - use seat-specific prices)

  // Pricing by seat type and level (same for both forward and return trips)
  lowerSeaterPrice  Float @default(0) // Price for lower deck seater from origin to this stop
  lowerSleeperPrice Float @default(0) // Price for lower deck sleeper from origin to this stop
  upperSleeperPrice Float @default(0) // Price for upper deck sleeper from origin to this stop

  // Relations
  groupsFrom BookingGroup[] @relation("GroupFromStop")
  groupsTo   BookingGroup[] @relation("GroupToStop")
  boardingPoints StopPoint[]

  @@unique([busId, stopIndex])
  @@index([busId, stopIndex])
  @@index([city])
  @@index([name])
}

enum StopPointType {
  BOARDING
  DROPPING
}

model StopPoint {
  id         String        @id @default(uuid())
  stopId     String
  stop       Stop          @relation(fields: [stopId], references: [id], onDelete: Cascade)
  type       StopPointType @default(BOARDING)
  name       String
  landmark   String?
  address    String?
  time       String
  pointOrder Int           @default(0)
  createdAt  DateTime      @default(now())

  boardingGroups BookingGroup[] @relation("GroupBoardingPoint")
  droppingGroups BookingGroup[] @relation("GroupDroppingPoint")

  @@index([stopId, type, pointOrder])
}

// ==================== SEAT MODEL ====================
model Seat {
  id         String @id @default(uuid())
  busId      String
  bus        Bus    @relation(fields: [busId], references: [id], onDelete: Cascade)
  seatNumber String // "1", "2", "3", etc.

  // Position in grid (top-left corner of the seat)
  row    Int // 0 to gridRows-1
  column Int // 0 to gridColumns-1

  // Dimensions (for sleeper seats that span multiple cells)
  rowSpan    Int @default(1) // 1 for normal, 2 for vertical sleeper
  columnSpan Int @default(1) // 1 for normal, 2 for horizontal sleeper

  type     SeatType // SEATER or SLEEPER
  level    SeatLevel // UPPER or LOWER
  isActive Boolean   @default(true) // For temporarily disabling seats

  bookings Booking[]

  @@unique([busId, seatNumber, level]) // Seat number must be unique per bus per level
  @@index([busId])
  @@index([busId, type])
  @@index([busId, level])
}

enum SeatType {
  SEATER
  SLEEPER
}

enum SeatLevel {
  UPPER
  LOWER
}

// ==================== TRIP MODEL ====================
model Trip {
  id            String         @id @default(uuid())
  busId         String
  bus           Bus            @relation(fields: [busId], references: [id], onDelete: Cascade)
  tripDate      DateTime       @db.Date // Date of journey
  status        TripStatus     @default(SCHEDULED)
  bookingGroups BookingGroup[]
  bookings      Booking[]
  createdAt     DateTime       @default(now())

  @@unique([busId, tripDate]) // Enables auto-trip creation with upsert
  @@index([busId, tripDate])
  @@index([tripDate, status])
}

enum TripStatus {
  SCHEDULED
  ONGOING
  COMPLETED
  CANCELLED
}

// ==================== BOOKING GROUP MODEL ====================
model BookingGroup {
  id         String      @id @default(uuid())
  userId     String
  user       User        @relation(fields: [userId], references: [id])
  tripId     String
  trip       Trip        @relation(fields: [tripId], references: [id])
  fromStopId String
  fromStop   Stop        @relation("GroupFromStop", fields: [fromStopId], references: [id])
  toStopId   String
  toStop     Stop        @relation("GroupToStop", fields: [toStopId], references: [id])
  totalPrice Float
  status     GroupStatus @default(PENDING)

  // Offer/Coupon fields
  offerId        String?
  offer          Offer?  @relation(fields: [offerId], references: [id])
  discountAmount Float   @default(0)
  finalPrice     Float? // totalPrice - discountAmount
  boardingPointId String?
  boardingPoint   StopPoint? @relation("GroupBoardingPoint", fields: [boardingPointId], references: [id], onDelete: SetNull)
  droppingPointId String?
  droppingPoint   StopPoint? @relation("GroupDroppingPoint", fields: [droppingPointId], references: [id], onDelete: SetNull)

  bookings  Booking[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([userId])
  @@index([tripId])
  @@index([status])
}

enum GroupStatus {
  PENDING
  CONFIRMED
  CANCELLED
  REFUNDED
}

// ==================== BOOKING MODEL ====================
model Booking {
  id      String        @id @default(uuid())
  groupId String
  group   BookingGroup  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  tripId  String
  trip    Trip          @relation(fields: [tripId], references: [id])
  seatId  String
  seat    Seat          @relation(fields: [seatId], references: [id])
  status  BookingStatus @default(CONFIRMED)

  passenger   Passenger?
  cancelledAt DateTime?
  createdAt   DateTime   @default(now())

  // CRITICAL: Prevent double booking - only one CONFIRMED booking per seat per trip
  @@unique([tripId, seatId], name: "unique_trip_seat")
  @@index([tripId, status])
  @@index([groupId])
}

enum BookingStatus {
  CONFIRMED
  CANCELLED
}

// ==================== PASSENGER MODEL ====================
model Passenger {
  id        String   @id @default(uuid())
  bookingId String   @unique
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  name      String
  age       Int
  gender    Gender
  phone     String?
  email     String?
  createdAt DateTime @default(now())

  @@index([bookingId])
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

// ==================== BUS AMENITIES MODEL ====================
model BusAmenities {
  id             String   @id @default(uuid())
  busId          String   @unique
  bus            Bus      @relation(fields: [busId], references: [id], onDelete: Cascade)
  hasWifi        Boolean  @default(false)
  hasCharging    Boolean  @default(false)
  hasAC          Boolean  @default(true)
  hasRestroom    Boolean  @default(false)
  hasBlanket     Boolean  @default(false)
  hasWaterBottle Boolean  @default(false)
  hasSnacks      Boolean  @default(false)
  hasTV          Boolean  @default(false)
  description    String?
  updatedAt      DateTime @updatedAt
}

// ==================== OFFERS & COUPONS MODEL ====================
model Offer {
  id               String         @id @default(uuid())
  code             String         @unique
  description      String
  discountType     DiscountType
  discountValue    Float // percentage or fixed amount
  minBookingAmount Float?
  maxDiscount      Float? // Max discount cap for percentage type
  validFrom        DateTime
  validUntil       DateTime
  usageLimit       Int? // null = unlimited
  usageCount       Int            @default(0)
  isActive         Boolean        @default(true)
  applicableBuses  String[] // Array of bus IDs, empty = all buses
  createdBy        String // Admin or super admin ID
  creatorRole      OfferCreatorRole @default(ADMIN)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  bookingGroups    BookingGroup[]

  @@index([code])
  @@index([isActive, validFrom, validUntil])
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum OfferCreatorRole {
  ADMIN
  SUPERADMIN
}

// ==================== NOTIFICATION MODEL ====================
model Notification {
  id        String           @id @default(uuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  metadata  Json? // Additional data like bookingId, tripId, etc.
  createdAt DateTime         @default(now())

  @@index([userId, isRead])
  @@index([createdAt])
}

enum NotificationType {
  BOOKING_CONFIRMED
  BOOKING_CANCELLED
  TRIP_CANCELLED
  OFFER_APPLIED
  TRIP_REMINDER
  GENERAL
}

// ==================== HOLIDAY MODEL ====================
model Holiday {
  id        String   @id @default(uuid())
  busId     String
  bus       Bus      @relation(fields: [busId], references: [id], onDelete: Cascade)
  date      DateTime @db.Date // Date when bus doesn't run
  reason    String? // Optional: "Diwali", "Maintenance", etc.
  createdBy String // Admin ID who created this holiday
  createdAt DateTime @default(now())

  @@unique([busId, date]) // Can't have duplicate holidays for same bus on same date
  @@index([busId, date])
  @@index([date])
}

// ==================== BUS IMAGE MODEL ====================
model BusImage {
  id         String   @id @default(uuid())
  busId      String
  bus        Bus      @relation(fields: [busId], references: [id], onDelete: Cascade)
  imageUrl   String // Cloudinary URL
  publicId   String // Cloudinary public ID for deletion
  uploadedBy String // Admin ID who uploaded
  createdAt  DateTime @default(now())

  @@index([busId])
}
